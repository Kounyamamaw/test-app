{% extends "base.html" %}

{% block title %}Dashboard - Trading Analysis{% endblock %}

{% block extra_css %}
<style>
    /* Layout 2 colonnes */
    .main-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    
    /* Colonne gauche - fixe */
    .left-sidebar {
        flex: 0 0 320px;
        position: sticky;
        top: 80px;
        height: fit-content;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    /* Colonne droite - scrollable */
    .right-content {
        flex: 1;
        min-width: 0;
    }
    
    /* Carte info utilisateur */
    .user-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .user-card h4 {
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .user-info-item {
        margin-bottom: 12px;
        font-size: 0.95rem;
    }
    
    .user-info-label {
        font-weight: 600;
        opacity: 0.9;
    }
    
    .user-info-value {
        margin-left: 8px;
    }
    
    .badge-admin {
        background: rgba(255,255,255,0.3);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
    }
    
    /* Guide d'utilisation */
    .guide-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .guide-card h5 {
        color: #667eea;
        margin-bottom: 15px;
        font-weight: 600;
    }
    
    .guide-step {
        display: flex;
        align-items: start;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    
    .step-number {
        background: #667eea;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.85rem;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .analysis-types {
        list-style: none;
        padding: 0;
    }
    
    .analysis-types li {
        padding: 8px 0;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.9rem;
    }
    
    .analysis-types li:last-child {
        border-bottom: none;
    }
    
    .analysis-types i {
        color: #667eea;
        margin-right: 8px;
    }
    
    /* Styles pour la colonne droite */
    .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
    }
    
    .positive { color: #10b981; }
    .negative { color: #ef4444; }
    
    .loading {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    
    #resultsSection {
        display: none;
    }
    
    .graph-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .graph-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #667eea;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .info-note {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    /* Responsive */
    @media (max-width: 992px) {
        .main-container {
            flex-direction: column;
        }
        
        .left-sidebar {
            position: static;
            flex: 1;
            max-height: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-white mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
    </div>
</div>

<div class="main-container">
    <!-- ========== COLONNE GAUCHE - FIXE ========== -->
    <div class="left-sidebar">
        <!-- Carte utilisateur -->
        <div class="user-card">
            <h4><i class="bi bi-person-circle"></i> Mon Profil</h4>
            <div class="user-info-item">
                <span class="user-info-label">Nom d'utilisateur :</span>
                <span class="user-info-value">{{ user.username }}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Email :</span>
                <span class="user-info-value">{{ user.email }}</span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Statut :</span>
                <span class="user-info-value">
                    {% if user.is_admin %}
                        <span class="badge-admin">Administrateur</span>
                    {% else %}
                        Membre
                    {% endif %}
                </span>
            </div>
            <div class="user-info-item">
                <span class="user-info-label">Membre depuis :</span>
                <span class="user-info-value">{{ user.created_at.strftime('%d/%m/%Y') }}</span>
            </div>
        </div>
        
        <!-- Guide d'utilisation -->
        <div class="guide-card">
            <h5><i class="bi bi-question-circle"></i> Comment utiliser ?</h5>
            <div class="guide-step">
                <div class="step-number">1</div>
                <div>Entrez le symbole boursier (ticker)</div>
            </div>
            <div class="guide-step">
                <div class="step-number">2</div>
                <div>Cliquez sur "Analyser"</div>
            </div>
            <div class="guide-step">
                <div class="step-number">3</div>
                <div>Attendez 10-30 secondes</div>
            </div>
            <div class="guide-step">
                <div class="step-number">4</div>
                <div>Consultez les statistiques et graphiques</div>
            </div>
        </div>
        
        <!-- Types d'analyse 
        <div class="guide-card">
            <h5><i class="bi bi-graph-up-arrow"></i> Types d'analyse</h5>
            <ul class="analysis-types">
                <li><i class="bi bi-arrow-repeat"></i> Cycle de Kitchin (894 jours)</li>
                <li><i class="bi bi-calendar3"></i> Cycle Annuel (saisonnalité)</li>
                <li><i class="bi bi-activity"></i> Volatilité (historique & projection)</li>
                <li><i class="bi bi-bezier2"></i> Coefficient de Hurst</li>
                <li><i class="bi bi-tsunami"></i> FFT (cycles dominants)</li>
            </ul>
        </div>-->
    </div>
    
    <!-- ========== COLONNE DROITE - SCROLLABLE ========== -->
    <div class="right-content">
        <!-- Formulaire d'analyse -->
        <div class="card mb-4">
            <div class="card-body p-4">
                <h3 class="mb-4">
                    <i class="bi bi-graph-up"></i> Analyse de Cycles Financiers
                </h3>
                
                <form id="analysisForm">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="ticker" class="form-label">Symbole Boursier (Ticker)</label>
                            <input type="text" class="form-control form-control-lg" id="ticker" name="ticker" 
                                   placeholder="Ex: AAPL, BTC-USD, ^GSPC..." required>
                            <small class="text-muted">
                                Actions (AAPL), Crypto (BTC-USD), Indices (^GSPC), Futures (GC=F), Forex (EURUSD=X)
                            </small>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-search"></i> Analyser
                            </button>
                        </div>
                    </div>
                </form>
                
                <!-- Exemples rapides -->
                <div class="mb-3">
                    <small class="text-muted">Exemples : </small>
                    <button class="btn btn-sm btn-outline-primary" onclick="setTicker('AAPL')">AAPL</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setTicker('BTC-USD')">BTC-USD</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setTicker('^GSPC')">S&P 500</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setTicker('MSFT')">MSFT</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="setTicker('TSLA')">TSLA</button>
                </div>
                
                <!-- Loading -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3"><strong>Analyse en cours...</strong></p>
                    <p class="text-muted">Cela peut prendre 10-30 secondes</p>
                </div>
            </div>
        </div>
        
        <!-- RÉSULTATS -->
        <div id="resultsSection">
            <!-- Statistiques principales -->
            <div class="card mb-4">
                <div class="card-body">
                    <h4 class="mb-4">
                        <i class="bi bi-clipboard-data"></i> Résultats pour <span id="resultTicker" class="text-primary"></span>
                    </h4>
                    
                    <div class="stats-grid" id="statsGrid">
                        <!-- Rempli dynamiquement -->
                    </div>
                    
                    <div class="info-note">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Note :</strong> Cette analyse utilise des algorithmes avancés de cycles financiers 
                        (Kitchin 894j, cycles annuels, volatilité, Hurst, FFT). 
                        Les graphiques ci-dessous montrent l'analyse complète.
                    </div>
                </div>
            </div>
            
            <!-- GRAPHIQUES PLOTLY -->
            <div class="row">
                <!-- Graph 1: Prix + Volume -->
                <div class="col-12">
                    <div class="graph-container">
                        <div class="graph-title">📈 Prix historique & Volume</div>
                        <div id="chart1"></div>
                    </div>
                </div>
                
                <!-- Graph 2: Cycle de Kitchin -->
                <div class="col-lg-6">
                    <div class="graph-container">
                        <div class="graph-title">🔄 Cycle de Kitchin (894 jours)</div>
                        <div id="chart2"></div>
                    </div>
                </div>
                
                <!-- Graph 3: Volatilité -->
                <div class="col-lg-6">
                    <div class="graph-container">
                        <div class="graph-title">📉 Analyse de la Volatilité</div>
                        <div id="chart3"></div>
                    </div>
                </div>
                
                <!-- Graph 4: Cycle Annuel -->
                <div class="col-lg-6">
                    <div class="graph-container">
                        <div class="graph-title">📅 Cycle Annuel (Saisonnalité)</div>
                        <div id="chart4"></div>
                    </div>
                </div>
                
                <!-- Graph 5: Gauge Volatilité -->
                <div class="col-lg-6">
                    <div class="graph-container">
                        <div class="graph-title">🎯 Niveau de Volatilité</div>
                        <div id="chart5"></div>
                    </div>
                </div>
                
                <!-- Graph 6: Décomposition -->
                <div class="col-12">
                    <div class="graph-container">
                        <div class="graph-title">📊 Décomposition des Rendements (STL)</div>
                        <div id="chart6"></div>
                    </div>
                </div>
                
                <!-- Graph 7: Hurst -->
                <div class="col-lg-6">
                    <div class="graph-container">
                        <div class="graph-title">📐 Coefficient de Hurst</div>
                        <div id="chart7"></div>
                    </div>
                </div>
                
                <!-- Graph 8: FFT Corona -->
                <div class="col-lg-6">
                    <div class="graph-container">
                        <div class="graph-title">🌊 Corona Spectrum (FFT)</div>
                        <div id="chart8"></div>
                    </div>
                </div>
                
                <!-- Graph 9: Cycles dominants -->
                <div class="col-12">
                    <div class="graph-container">
                        <div class="graph-title">🔝 Cycles Dominants (Top 5)</div>
                        <div id="chart9"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<script>
function setTicker(symbol) {
    document.getElementById('ticker').value = symbol;
}

document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const ticker = document.getElementById('ticker').value.trim().toUpperCase();
    const loading = document.getElementById('loading');
    const resultsSection = document.getElementById('resultsSection');
    
    if (!ticker) {
        alert('Veuillez entrer un symbole boursier');
        return;
    }
    
    // Show loading
    loading.style.display = 'block';
    resultsSection.style.display = 'none';
    
    // Scroll to loading
    loading.scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    try {
        const formData = new FormData();
        formData.append('ticker', ticker);
        
        const response = await fetch('/analyze', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erreur lors de l\'analyse');
        }
        
        console.log('✅ Données reçues:', data);
        
        // Afficher le ticker
        document.getElementById('resultTicker').textContent = data.ticker;
        
        // Créer les cartes de stats
        const stats = [
            { label: 'Prix actuel', value: `$${data.current_price}`, color: '' },
            { label: 'Prédiction', value: data.prediction, color: '' },
            { label: 'Confiance', value: `${(data.confidence * 100).toFixed(0)}%`, color: '' },
            { label: 'Prochain Cycle', value: data.next_cycle, color: '' },
            { label: 'Écart vs moyenne', value: `${data.deviation > 0 ? '+' : ''}${data.deviation}%`, 
              color: data.deviation > 0 ? 'positive' : 'negative' },
            { label: 'Volatilité', value: `${data.volatility}%`, color: '' },
            { label: 'Outlook 12m', value: `${data.volatility_outlook}%`, color: '' },
            { label: 'Niveau Vol', value: data.volatility_level, 
              color: data.volatility_level === 'High' ? 'negative' : data.volatility_level === 'Low' ? 'positive' : '' }
        ];
        
        document.getElementById('statsGrid').innerHTML = stats.map(s => `
            <div class="stat-box">
                <div class="stat-label">${s.label}</div>
                <div class="stat-value ${s.color}">${s.value}</div>
            </div>
        `).join('');
        
        // AFFICHER LES GRAPHIQUES PLOTLY
        const plotConfig = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        };
        
        const graphs = data.full_analysis?.graphs || {};
        
        console.log('📊 Graphiques disponibles:', Object.keys(graphs));
        
        // Graph 1: Prix + Volume
        if (graphs.price_volume && graphs.price_volume.data) {
            Plotly.newPlot('chart1', graphs.price_volume.data, graphs.price_volume.layout, plotConfig);
        }
        
        // Graph 2: Kitchin
        if (graphs.kitchin && graphs.kitchin.data) {
            Plotly.newPlot('chart2', graphs.kitchin.data, graphs.kitchin.layout, plotConfig);
        }
        
        // Graph 3: Volatilité
        if (graphs.volatility && graphs.volatility.data) {
            Plotly.newPlot('chart3', graphs.volatility.data, graphs.volatility.layout, plotConfig);
        }
        
        // Graph 4: Cycle annuel
        if (graphs.annual && graphs.annual.data) {
            Plotly.newPlot('chart4', graphs.annual.data, graphs.annual.layout, plotConfig);
        }
        
        // Graph 5: Gauge volatilité
        if (graphs.vol_gauge && graphs.vol_gauge.data) {
            Plotly.newPlot('chart5', graphs.vol_gauge.data, graphs.vol_gauge.layout, plotConfig);
        }
        
        // Graph 6: Décomposition
        if (graphs.returns && graphs.returns.data) {
            Plotly.newPlot('chart6', graphs.returns.data, graphs.returns.layout, plotConfig);
        }
        
        // Graph 7: Hurst
        if (graphs.hurst && graphs.hurst.data) {
            Plotly.newPlot('chart7', graphs.hurst.data, graphs.hurst.layout, plotConfig);
        }
        
        // Graph 8: FFT Corona
        if (graphs.corona && graphs.corona.data) {
            Plotly.newPlot('chart8', graphs.corona.data, graphs.corona.layout, plotConfig);
        }
        
        // Graph 9: Cycles dominants
        if (graphs.dominant_cycles && graphs.dominant_cycles.data) {
            Plotly.newPlot('chart9', graphs.dominant_cycles.data, graphs.dominant_cycles.layout, plotConfig);
        }
        
        // Afficher les résultats
        loading.style.display = 'none';
        resultsSection.style.display = 'block';
        
        // Scroll vers les résultats
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Resize après affichage
        setTimeout(() => {
            window.dispatchEvent(new Event('resize'));
        }, 100);
        
    } catch (error) {
        loading.style.display = 'none';
        alert('❌ Erreur : ' + error.message);
        console.error('Erreur complète:', error);
    }
});

// Support touche Entrée
document.getElementById('ticker').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('analysisForm').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %}